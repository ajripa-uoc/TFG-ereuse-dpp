# .github/workflows/id-index-api-ci-cd.yaml
name: CI/CD id-index-api
on:
  push:
    branches: [ main ]
    paths:
      - 'idIndexApi/**'
  workflow_dispatch:

permissions:
  contents: write
  packages: write
  id-token: write

env:
  APP_NAME: tfg-ereuse-dpp
  IMAGE_NAME: id-index-api
  SERVICE_NAME: idIndexApi
  CONTEXT_PATH: ./idIndexApi
  DOCKERFILE_PATH: ./idIndexApi/Dockerfile

jobs:
  build:
    name: CD
    uses: ./.github/workflows/docker-build-template.yaml
    with:
      image_name: ${{ env.APP_NAME }}/${{ env.IMAGE_NAME }}
      context_path: ${{ env.CONTEXT_PATH }}
      dockerfile_path: ${{ env.DOCKERFILE_PATH }}

  deploy:
    name: CI
    needs: build
    uses: ./.github/workflows/update-helm-template.yaml
    with:
      chart_name: ${{ env.APP_NAME }}
      service_name: ${{ env.SERVICE_NAME }}
      image_tag: ${{ needs.build.outputs.sha_tag }}
      repo_name: ${{ needs.build.outputs.image_full_name }}